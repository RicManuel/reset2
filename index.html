<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Match Tracker ‚Äî Futsal v28</title>
  <style>
    :root{--bg:#0f1115;--panel:#0b0e16;--card:#121727;--muted:#9aa2b1;--text:#e8ecf1;--accent:#4f8cff;--ok:#15c27b;--warn:#ffcc00;--danger:#ff5d5d;--ring:rgba(79,140,255,.35);--pink:#ff5fa3;--blue:#2f72ff;--turq:#00c2ff;--orange:#ff9800;--greenGrad:linear-gradient(180deg,#10351e,#0b1f13);--orangeGrad:linear-gradient(180deg,#3a240a,#1c1308);
      --blueGrad:linear-gradient(180deg,#0b346f,#0a254b);--pausedGrad:linear-gradient(180deg,#3a0a0a,#1c0a0a);--fieldGrad:linear-gradient(180deg,#2a0f0f,#140707);--oppGrad:linear-gradient(180deg,#4a420a,#2b2506);--teamGrad:linear-gradient(180deg,#0f2c18,#0a1b10)}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 1200px at 80% -10%, #182033 0%, var(--bg) 60%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;-webkit-tap-highlight-color:transparent}
    header{position:sticky;top:0;z-index:60;background:linear-gradient(180deg,rgba(10,12,18,.95),rgba(10,12,18,.7) 60%,rgba(10,12,18,0));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;font-size:14px}.tabs{display:flex;gap:6px;flex-wrap:wrap}.tab{background:#1a1f2e;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer;font-size:13px}.tab.active{background:#2a3250;border-color:#3b4d93}.controls{display:flex;gap:6px;flex-wrap:wrap}button{appearance:none;border:0;border-radius:10px;padding:6px 10px;background:#212537;color:var(--text);font-weight:700;box-shadow:0 0 0 1px rgba(255,255,255,.06);cursor:pointer;font-size:13px}button:active{transform:scale(.98)}.accent{background:linear-gradient(180deg,#2a4ea8,#1b2f74);box-shadow:0 0 0 1px #2c4fb9,0 0 0 6px rgba(79,140,255,.35)}.danger{background:linear-gradient(180deg,#893131,#5a1d1d)}.ghost{background:#1a1d2b}.hint{color:var(--muted);font-size:12px}
    .layout{display:grid;gap:10px;padding:10px;padding-bottom:90px;max-width:1400px;margin:0 auto}.layout.main{grid-template-columns:3fr 1fr;align-items:stretch}.layout.full{grid-template-columns:1fr}
    .grid{display:grid;gap:6px}.grid.profiles{grid-template-columns:repeat(auto-fill,minmax(208px,1fr))}.grid.six{grid-template-columns:repeat(2,minmax(0,1fr));align-items:stretch}.rowTitle{font-weight:800;color:var(--muted);margin:2px 0 2px 4px;font-size:11px}
    .card{background:linear-gradient(180deg,#171b28,#10131c);border-radius:12px;padding:6px;box-shadow:0 0 0 1px rgba(255,255,255,.06),0 6px 18px rgba(0,0,0,.3);display:flex;flex-direction:column;gap:6px;width:100%;transition:box-shadow .2s ease,transform .02s ease;overflow:hidden}.card.field{background:var(--fieldGrad);box-shadow:0 0 0 2px rgba(255,90,90,.35)}.card.opponent{background:var(--oppGrad);box-shadow:0 0 0 2px rgba(255,221,87,.6)}.card.gk{background:linear-gradient(180deg,#0e1730,#081025);box-shadow:0 0 0 2px rgba(47,114,255,.5)}.card.team{background:var(--teamGrad);box-shadow:0 0 0 2px rgba(21,194,123,.5)}.card:active{transform:scale(.995)}
    .name{display:flex;align-items:center;gap:6px;justify-content:space-between}.name input{width:100%;background:#0f1320;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:8px;font-size:13px;font-weight:800;padding:6px 8px}
    .avatarRow{display:flex;align-items:center;gap:8px}.avatar{width:38px;height:38px;border-radius:50%;background:#2a3250;color:#dfe6ff;display:flex;align-items:center;justify-content:center;font-weight:900;box-shadow:0 0 0 1px rgba(255,255,255,.08);background-size:cover;background-position:center}.avatar.lg{width:52px;height:52px}.avatar.sm{width:24px;height:24px;font-size:12px}.avatarBtn{padding:5px 7px}.roleSel{background:#0f1320;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:5px 7px;font-weight:800;font-size:12px}
    .picker{position:relative}.picker button{padding:6px 8px;font-size:12px}.pickerList{position:absolute;top:110%;right:0;min-width:200px;background:#0f1320;border:1px solid rgba(255,255,255,.1);border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,.35);display:none;max-height:220px;overflow:auto;z-index:9999 -webkit-overflow-scrolling: touch;}.pickerList.open{display:block}.pickerList div{padding:8px 10px;cursor:pointer}.pickerList div:hover{background:#1a2037}
    .stats{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:6px;width:100%}.stats.field{grid-template-columns:repeat(4,minmax(0,1fr))}.stat{background:#0f1320;border-radius:10px;padding:6px;display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;border:2px solid rgba(255,255,255,.10);gap:4px;min-height:86px}.stat label{font-size:10px;letter-spacing:.3px;color:var(--muted);text-transform:uppercase;font-weight:800;text-align:center;display:flex;align-items:center;justify-content:center;min-height:18px;line-height:1.05;padding:2px 0}.count{font-size:18px;font-weight:900;text-align:center;height:20px;display:flex;align-items:center;justify-content:center}
    .plus,.minus,.action{width:100%;display:block;border-radius:8px;cursor:pointer;padding:0;font-weight:900}.plus,.minus{height:30px;font-size:16px;background:#0f1320}.minus{background:#3a1d1d;border:none!important;box-shadow:none!important}.action{height:54px;font-size:18px}
    .stats.field .stat:nth-child(4n+1){border-color:#15c27b;box-shadow:0 0 0 1px rgba(21,194,123,.25) inset}.stats.field .stat:nth-child(4n+2){border-color:#4f8cff;box-shadow:0 0 0 1px rgba(79,140,255,.25) inset}.stats.field .stat:nth-child(4n+3){border-color:#00c2ff;box-shadow:0 0 0 1px rgba(0,194,255,.25) inset}.stats.field .stat:nth-child(4n+4){border-color:#ff9800;box-shadow:0 0 0 1px rgba(255,152,0,.25) inset}
    .stats.field .stat:nth-child(1) .plus{border:2px solid #15c27b}.stats.field .stat:nth-child(2) .plus{border:2px solid #2f72ff}.stats.field .stat:nth-child(3) .plus{border:2px solid #00c2ff}.stats.field .stat:nth-child(4) .plus{border:2px solid #ff9800}
    .stats:not(.field) .stat:nth-child(1){border-color:#ff5d5d;box-shadow:0 0 0 1px rgba(255,93,93,.25) inset}.stats:not(.field) .stat:nth-child(2){border-color:#15c27b;box-shadow:0 0 0 1px rgba(21,194,123,.25) inset}.stats:not(.field) .stat:nth-child(3){border-color:#ff5fa3;box-shadow:0 0 0 1px rgba(255,95,163,.25) inset}.stats:not(.field) .stat:nth-child(4){border-color:#ff9800;box-shadow:0 0 0 1px rgba(255,152,0,.25) inset}.stats:not(.field) .stat:nth-child(5){border-color:#2f72ff;box-shadow:0 0 0 1px rgba(47,114,255,.25) inset}
    .stats:not(.field) .stat:nth-child(1) .plus{border:2px solid #ff5d5d}.stats:not(.field) .stat:nth-child(2) .plus{border:2px solid #15c27b}.stats:not(.field) .stat:nth-child(3) .plus{border:2px solid #ff5fa3}.stats:not(.field) .stat:nth-child(4) .plus{border:2px solid #ff9800}.stats:not(.field) .stat:nth-child(5) .plus{border:2px solid #2f72ff}
    .panel{border-radius:14px;padding:10px;box-shadow:0 0 0 1px rgba(255,255,255,.06),0 10px 24px rgba(0,0,0,.35);position:sticky;top:62px;display:flex;flex-direction:column;gap:8px;min-width:280px;max-width:380px;margin-left:auto;overflow:hidden}.panel.green{background:var(--greenGrad);border:1px solid rgba(46,204,113,.35)}.panel.orange{background:var(--blueGrad);border:1px solid rgba(0,170,255,.55)}.panel.paused{background:var(--pausedGrad);border:1px solid rgba(255,93,93,.5)}.panel h3{margin:0;font-size:14px}.timerDisplay{font-size:40px;font-weight:900;text-align:center;letter-spacing:1px}
    .scoreboard{display:flex;flex-direction:column;gap:8px;align-items:center}.scoreRow{display:flex;gap:10px;align-items:center;font-weight:900;font-size:28px}.teamBox{display:flex;flex-direction:column;align-items:center;gap:2px}.teamMain{display:flex;align-items:center;gap:8px}.teamMain .logo{width:56px;height:56px;background:none;background-size:contain;background-repeat:no-repeat;background-position:center;display:flex;align-items:center;justify-content:center;font-weight:900;color:#dfe6ff}.scoreCol{display:flex;flex-direction:column;align-items:center}.scoreBadge{padding:4px 10px;border-radius:10px;background:#1a1f2e;border:1px solid rgba(255,255,255,.08);font-size:28px}.foulsRow{font-size:11px;color:#cbd5e1;opacity:.85;margin-top:2px}
    .logo{width:56px;height:56px;background:none;background-size:contain;background-repeat:no-repeat;background-position:center;display:flex;align-items:center;justify-content:center;font-weight:900;color:#dfe6ff}.logo.small{width:48px;height:48px}
    .halfRow{display:flex;gap:8px;justify-content:center;align-items:center}
    .miniFouls{display:flex;flex-direction:column;gap:6px;overflow:visible;padding-right:0;max-height:none}.hcard{display:grid;grid-template-columns: 1.4fr 0.9fr 0.9fr 0.9fr;align-items:center;gap:8px;background:#101521;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 8px;min-height:54px}.who{display:flex;align-items:center;gap:8px;min-width:0}.hcard .avatar{width:28px;height:28px;flex:0 0 auto}.hname{font-weight:800;font-size:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;white-space:normal;overflow:hidden;line-height:1.1;max-height:2.2em}.col{display:flex;flex-direction:column;align-items:center;gap:4px}.colLabel{font-size:12px;color:#cbd5e1;opacity:.95}.colCount{font-size:16px;font-weight:900;min-width:18px;text-align:center}.colBtns{display:flex;gap:6px}.mini{height:26px;width:26px;display:flex;align-items:center;justify-content:center;font-weight:900;border-radius:6px}.mini.plus{background:#1d2a46}.mini.minus{background:#3a1d1d}
    table{width:100%;border-collapse:collapse;font-size:14px}th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;text-align:left}th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}.note{font-size:12px;color:var(--muted)}.tblName{display:flex;align-items:center;gap:8px}#timeTableWrap tbody tr:nth-child(even){background:rgba(255,255,255,.035)}
    .fivev4Box{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}.pill{background:#1a1f2e;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:6px 10px;font-size:13px;font-weight:800}
    .colTop{display:flex;align-items:center;gap:6px;justify-content:center}
    .legend{margin-top:10px;font-size:12px;color:#cbd5e1;opacity:.9}.legend code{background:#0e1320;border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:2px 6px;margin-right:6px;display:inline-block}
  
    .timeBadge{min-width:48px;text-align:center;font-weight:900;font-size:12px;padding:4px 6px;border-radius:8px;background:#0f1320;border:1px solid rgba(255,255,255,.12);color:#cbd5e1;box-shadow:0 0 0 1px rgba(255,255,255,.04) inset}
    .avatarRow .timeBadge{margin-left:4px;margin-right:4px}

  .timeBadge.warn{border:2px solid yellow!important;border-radius:6px;}
.timeBadge.alert{border:2px solid red!important;border-radius:6px;}
</style>
</head>
<body>
  <header>
    <div class="title"><span>‚öΩ Match Tracker ‚Äî Futsal</span><small id="matchLabel" style="color:var(--muted)">Jogo atual</small></div>
    <div class="tabs">
      <div class="tab active" id="tabPerfis">Perfis</div><div class="tab" id="tabH1">1¬™ Parte</div><div class="tab" id="tabH2">2¬™ Parte</div><div class="tab" id="tabP1">1¬™ Prol.</div><div class="tab" id="tabP2">2¬™ Prol.</div><div class="tab" id="tabTempo">Stats</div><div class="tab" id="tabDefs">Defini√ß√µes</div>
    </div>
    <div class="controls"><button id="renameMatchBtn" class="ghost">Renomear</button><button id="exportBtn" class="accent">Exportar CSV</button><button id="resetBtn" class="danger">Reset</button></div>
  </header>

  <main id="pagePerfis" class="layout full">
    <section>
      <div class="grid profiles" id="profilesGrid"></div>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="addFieldBtn" class="ghost">+ Atleta Campo</button><button id="addGKBtn" class="ghost">+ Guarda‚Äëredes</button></div>
      <div class="note" style="margin-top:8px">Os dois primeiros cart√µes s√£o as <b>Equipas</b> (a tua e a Advers√°ria). Abaixo adiciona as jogadoras (Campo/GR) e fotos.</div>
    </section>
  </main>

  <main id="pageH1" class="layout main" style="display:none">
    <section>
      <div class="rowTitle">Linha 1 ‚Äî 1¬™ Parte</div><div class="grid six" id="h1GridTop"></div>
      <div class="rowTitle">Linha 2</div><div class="grid six" id="h1GridMid"></div>
      <div class="rowTitle">Linha 3</div><div class="grid six" id="h1GridBot"></div>
    </section>
    <aside class="panel green paused" id="panel_H1">
      <h3>‚è±Ô∏è 1¬™ Parte</h3>
      <div class="scoreboard">
        <div class="timerDisplay" id="timerDisplay_H1">20:00</div>
        <div class="scoreRow">
          <div class="teamBox"><div class="teamMain"><div class="logo" id="leftLogo_H1">N</div><div class="scoreCol"><div class="scoreBadge" id="leftScore_H1">0</div><div class="foulsRow"><span id="leftFouls_H1">0</span></div></div></div></div>
          <div style="opacity:.6">‚Äî</div>
          <div class="teamBox"><div class="teamMain"><div class="scoreCol"><div class="scoreBadge" id="rightScore_H1">0</div><div class="foulsRow"><span id="rightFouls_H1">0</span></div></div><div class="logo" id="rightLogo_H1">A</div></div></div>
        </div>
      </div>
      <div class="halfRow"><button id="toggleTimerBtn_H1" class="action">Iniciar / Pausar</button></div>
      <div class="miniFouls" id="miniFouls_H1"></div>
    </aside>
  </main>

  <main id="pageH2" class="layout main" style="display:none">
    <section>
      <div class="rowTitle">Linha 1 ‚Äî 2¬™ Parte</div><div class="grid six" id="h2GridTop"></div>
      <div class="rowTitle">Linha 2</div><div class="grid six" id="h2GridMid"></div>
      <div class="rowTitle">Linha 3</div><div class="grid six" id="h2GridBot"></div>
    </section>
    <aside class="panel orange paused" id="panel_H2">
      <h3>‚è±Ô∏è 2¬™ Parte</h3>
      <div class="scoreboard">
        <div class="timerDisplay" id="timerDisplay_H2">20:00</div>
        <div class="scoreRow">
          <div class="teamBox"><div class="teamMain"><div class="logo" id="leftLogo_H2">N</div><div class="scoreCol"><div class="scoreBadge" id="leftScore_H2">0</div><div class="foulsRow"><span id="leftFouls_H2">0</span></div></div></div></div>
          <div style="opacity:.6">‚Äî</div>
          <div class="teamBox"><div class="teamMain"><div class="scoreCol"><div class="scoreBadge" id="rightScore_H2">0</div><div class="foulsRow"><span id="rightFouls_H2">0</span></div></div><div class="logo" id="rightLogo_H2">A</div></div></div>
        </div>
      </div>
      <div class="halfRow"><button id="toggleTimerBtn_H2" class="action">Iniciar / Pausar</button></div>
      <div class="miniFouls" id="miniFouls_H2"></div>
    </aside>
  </main>

<main id="pageP1" class="layout main" style="display:none">
    <section>
      <div class="rowTitle">Linha 1 ‚Äî 1¬™ Prol.</div><div class="grid six" id="p1GridTop"></div>
      <div class="rowTitle">Linha 2</div><div class="grid six" id="p1GridMid"></div>
      <div class="rowTitle">Linha 3</div><div class="grid six" id="p1GridBot"></div>
    </section>
    <aside class="panel green paused" id="panel_P1">
      <h3>‚è±Ô∏è 1¬™ Prol.</h3>
      <div class="scoreboard">
        <div class="timerDisplay" id="timerDisplay_P1">20:00</div>
        <div class="scoreRow">
          <div class="teamBox"><div class="teamMain"><div class="logo" id="leftLogo_P1">N</div><div class="scoreCol"><div class="scoreBadge" id="leftScore_P1">0</div><div class="foulsRow"><span id="leftFouls_P1">0</span></div></div></div></div>
          <div style="opacity:.6">‚Äî</div>
          <div class="teamBox"><div class="teamMain"><div class="scoreCol"><div class="scoreBadge" id="rightScore_P1">0</div><div class="foulsRow"><span id="rightFouls_P1">0</span></div></div><div class="logo" id="rightLogo_P1">A</div></div></div>
        </div>
      </div>
      <div class="halfRow"><button id="toggleTimerBtn_P1" class="action">Iniciar / Pausar</button></div>
      <div class="miniFouls" id="miniFouls_P1"></div>
    </aside>
  </main>

<main id="pageP2" class="layout main" style="display:none">
    <section>
      <div class="rowTitle">Linha 1 ‚Äî 2¬™ Prol.</div><div class="grid six" id="p2GridTop"></div>
      <div class="rowTitle">Linha 2</div><div class="grid six" id="p2GridMid"></div>
      <div class="rowTitle">Linha 3</div><div class="grid six" id="p2GridBot"></div>
    </section>
    <aside class="panel orange paused" id="panel_P2">
      <h3>‚è±Ô∏è 2¬™ Prol.</h3>
      <div class="scoreboard">
        <div class="timerDisplay" id="timerDisplay_P2">20:00</div>
        <div class="scoreRow">
          <div class="teamBox"><div class="teamMain"><div class="logo" id="leftLogo_P2">N</div><div class="scoreCol"><div class="scoreBadge" id="leftScore_P2">0</div><div class="foulsRow"><span id="leftFouls_P2">0</span></div></div></div></div>
          <div style="opacity:.6">‚Äî</div>
          <div class="teamBox"><div class="teamMain"><div class="scoreCol"><div class="scoreBadge" id="rightScore_P2">0</div><div class="foulsRow"><span id="rightFouls_P2">0</span></div></div><div class="logo" id="rightLogo_P2">A</div></div></div>
        </div>
      </div>
      <div class="halfRow"><button id="toggleTimerBtn_P2" class="action">Iniciar / Pausar</button></div>
      <div class="miniFouls" id="miniFouls_P2"></div>
    </aside>
  </main>

  <main id="pageTempo" class="layout full" style="display:none">
    <section>
      <div class="fivev4Box" id="fivev4Box"></div>
      <div class="halfRow" style="justify-content:flex-start;margin-bottom:8px"><label for="tempoFilter">Ver estat√≠sticas de:</label>
        <select id="tempoFilter"><option value="ALL">Jogo todo</option><option value="H1">1¬™ parte</option><option value="H2">2¬™ parte</option></select>
      </div>
      <div id="timeTableWrap"></div>
      <div class="legend" id="legendBlock">
        <div><code>G</code> Golos ‚Ä¢ <code>R</code> Remates ‚Ä¢ <code>RB</code> Remates √† Baliza ‚Ä¢ <code>D</code> Desarmes ‚Ä¢ <code>GS</code> Golos Sofridos (GR) ‚Ä¢ <code>D</code> Defesas (GR) ‚Ä¢ <code>PC</code> Passes Certos (GR) ‚Ä¢ <code>PF</code> Passes Falhados (GR) ‚Ä¢ <code>FO</code> Faltas ‚Ä¢ <code>üü®</code> Amarelos ‚Ä¢ <code>üü•</code> Vermelhos</div>
      </div>
      <div class="note" style="margin-top:8px">M√©dia por entrada = tempo total / n¬∫ entradas. (Tempo em minutos)</div>
    </section>
  </main>

  <main id="pageDefs" class="layout full" style="display:none">
    <section>
      <h3>Defini√ß√µes do Jogo</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:end">
        <div><label>Tempo da 1¬™ Parte (min)</label><br/><input id="defMin_H1" type="number" min="1" max="60" value="20" /></div>
        <div><label>Tempo da 2¬™ Parte (min)</label><br/><input id="defMin_H2" type="number" min="1" max="60" value="20" /></div><div><label>Tempo da 1¬™ Prol. (min)</label><br/><input id="defMin_P1" type="number" min="1" max="60" value="20" /></div><div><label>Tempo da 2¬™ Prol. (min)</label><br/><input id="defMin_P2" type="number" min="1" max="60" value="20" /></div>
        <div><label>Local</label><br/><select id="venueSel"><option value="CASA">Casa</option><option value="FORA">Fora</option></select></div>
        <button id="applyDefsBtn" class="accent">Aplicar</button>
        <button id="resetH1Btn" class="ghost">Reset 1¬™ Parte</button>
        <button id="resetH2Btn" class="ghost">Reset 2¬™ Parte</button><button id="resetP1Btn" class="ghost">Reset 1¬™ Prol.</button><button id="resetP2Btn" class="ghost">Reset 2¬™ Prol.</button>
      </div>
      <p class="note">Ao aplicar, o tempo definido passa a ser o novo total da parte. O cron√≥metro n√£o inicia automaticamente. Os bot√µes de reset do tempo est√£o aqui.</p>
    </section>
  </main>

  <div class="footerbar"><div class="controls"><span class="hint" id="autosaveHint">Guardado ‚úì</span></div></div>

  <script>
    const LS_KEY="match-tracker-v22";const roles={GK:"GK",F:"F"};const HALVES=["H1","H2","P1","P2"];const ROW_MIN=84;
    let state={matchName:`Jogo ${new Date().toLocaleDateString('pt-PT')}`,team:{name:"Minha Equipa",photo:null},opponent:{name:"Advers√°ria",G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0,photo:null,parts:{H1:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0},H2:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0},P1:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0},P2:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0}}},profiles:[],lineup:{GK:null,F1:null,F2:null,F3:null,F4:null},score:{us:0,them:0},halves:{H1:{duration:1200,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0},H2:{duration:1200,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0},P1:{duration:1200,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0},P2:{duration:1200,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}},venue:"CASA",fivevfour:{timeSec:0,parts:{H1:{timeSec:0,G:0,S:0,OT:0,T:0},H2:{timeSec:0,G:0,S:0,OT:0,T:0},P1:{timeSec:0,G:0,S:0,OT:0,T:0},P2:{timeSec:0,G:0,S:0,OT:0,T:0}}}};
    function uid(){return Math.random().toString(36).slice(2,10)}
    function newProfile(n,r){return{id:uid(),name:n||(r==="GK"?"Guarda‚Äëredes":"Atleta"),number:"",role:r,photo:null,S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,entries:0,parts:{H1:{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0},H2:{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0},P1:{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0},P2:{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0}}}}
    function save(){localStorage.setItem(LS_KEY,JSON.stringify(state));const h=document.getElementById("autosaveHint");h.textContent="Guardado ‚úì";h.style.opacity=1;setTimeout(()=>{h.style.opacity=.5},1e3)}
    function load(){const raw=localStorage.getItem(LS_KEY);if(raw){try{state=JSON.parse(raw)}catch(e){}}if(!state.team){state={...state,team:{name:"Minha Equipa",photo:null}}}if(!state.venue){state.venue="CASA"}if(!(state.profiles&&state.profiles.length)){state.profiles=[newProfile("GR 1",roles.GK)];for(let i=1;i<=8;i++)state.profiles.push(newProfile("Atleta "+i,roles.F))}if(!state.lineup.GK){const gk=state.profiles.find(p=>p.role===roles.GK)||state.profiles[0];if(gk){state.lineup.GK=gk.id;gk.entries++}}const flds=state.profiles.filter(p=>p.role===roles.F).slice(0,4);["F1","F2","F3","F4"].forEach((k,i)=>{if(!state.lineup[k]&&flds[i]){state.lineup[k]=flds[i].id;flds[i].entries++}});if(!state.opponent.parts){state.opponent.parts={H1:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0},H2:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0}}}
if(!state.opponent.parts.P1){state.opponent.parts.P1={G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0}}
if(!state.opponent.parts.P2){state.opponent.parts.P2={G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0}}
for(const p of state.profiles){if(!p.parts.P1){p.parts.P1={S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0}} if(!p.parts.P2){p.parts.P2={S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0}}["H1","H2","P1","P2"].forEach(h=>{ if(!p.parts[h].hasOwnProperty("timeSec")) p.parts[h].timeSec=0; if(!p.parts[h].hasOwnProperty("sessionSec")) p.parts[h].sessionSec=0; });}
if(!state.halves.P1){state.halves.P1={duration:state.halves.H1?.duration||1200,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}
if(!state.halves.P2){state.halves.P2={duration:state.halves.H2?.duration||1200,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}
if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();updateAllTimeBadges();setupRAF();setTimeout(()=>{["H1","H2","P1","P2"].forEach(fitCardsToViewport)},0)}
    function showPage(id){document.getElementById("pagePerfis").style.display=id==="Perfis"?"grid":"none";document.getElementById("pageH1").style.display=id==="H1"?"grid":"none";document.getElementById("pageH2").style.display=id==="H2"?"grid":"none";document.getElementById("pageP1").style.display=id==="P1"?"grid":"none";document.getElementById("pageP2").style.display=id==="P2"?"grid":"none";document.getElementById("pageTempo").style.display=id==="Tempo"?"grid":"none";document.getElementById("pageDefs").style.display=id==="Defs"?"grid":"none";for(const t of["tabPerfis","tabH1","tabH2","tabP1","tabP2","tabTempo","tabDefs"])document.getElementById(t).classList.remove("active");document.getElementById("tab"+id).classList.add("active");if(id==="Tempo"){buildFivev4Box();buildTimeTable()}if(id==="H1"){setTimeout(()=>fitCardsToViewport("H1"),0)}if(id==="H2"){setTimeout(()=>fitCardsToViewport("H2"),0)}if(id==="P1"){setTimeout(()=>fitCardsToViewport("P1"),0)}if(id==="P2"){setTimeout(()=>fitCardsToViewport("P2"),0)}}
    document.getElementById("tabPerfis").onclick=()=>showPage("Perfis");document.getElementById("tabH1").onclick=()=>showPage("H1");document.getElementById("tabH2").onclick=()=>showPage("H2");document.getElementById("tabP1").onclick=()=>showPage("P1");document.getElementById("tabP2").onclick=()=>showPage("P2");document.getElementById("tabTempo").onclick=()=>showPage("Tempo");document.getElementById("tabDefs").onclick=()=>showPage("Defs");
    document.getElementById("renameMatchBtn").onclick=()=>{const n=prompt("Nome do jogo:",state.matchName||"");if(n){state.matchName=n.trim();document.getElementById("matchLabel").textContent=state.matchName;save()}};
    document.getElementById("resetBtn").onclick=()=>{// --- keep durations defined in "Defini√ß√µes" even after reset, and clear on-field players ---
const _keepH1 = (state.halves&&state.halves.H1&&state.halves.H1.duration) || ((()=>{const el=document.getElementById("defMin_H1");return (Math.max(1,parseInt((el&&el.value)||"20",10))*60)})());
const _keepH2 = (state.halves&&state.halves.H2&&state.halves.H2.duration) || ((()=>{const el=document.getElementById("defMin_H2");return (Math.max(1,parseInt((el&&el.value)||"20",10))*60)})());
const _keepP1 = (state.halves&&state.halves.P1&&state.halves.P1.duration) || ((()=>{const el=document.getElementById("defMin_P1");return (Math.max(1,parseInt((el&&el.value)||"10",10))*60)})());
const _keepP2 = (state.halves&&state.halves.P2&&state.halves.P2.duration) || ((()=>{const el=document.getElementById("defMin_P2");return (Math.max(1,parseInt((el&&el.value)||"10",10))*60)})());

// Clear any current lineup so both parts and prolongamentos start with no athletes on field
if(state.lineup){
  for(const k of ["GK","F1","F2","F3","F4"]){
    if(k in state.lineup) delete state.lineup[k];
  }
}

// We'll reapply the preserved durations after the built-in reset logic runs.if(!confirm("Reset geral a contadores, faltas e tempos?"))return;for(const p of state.profiles){Object.assign(p,{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,entries:0});p.parts={H1:{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0},H2:{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0},P1:{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0},P2:{S:0,OT:0,T:0,G:0,GA:0,SV:0,PC:0,PF:0,FO:0,YC:0,RC:0,timeSec:0,sessionSec:0}}}state.opponent={name:state.opponent.name||"Advers√°ria",photo:state.opponent.photo||null,G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0,parts:{H1:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0},H2:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0},P1:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0},P2:{G:0,S:0,OT:0,T:0,FO:0,YC:0,RC:0}}};state.score={us:0,them:0};state.halves={H1:{duration:state.halves.H1.duration||1200,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0},H2:{duration:state.halves.H2.duration||1200,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}};state.fivevfour={timeSec:0,parts:{H1:{timeSec:0,G:0,S:0,OT:0,T:0},H2:{timeSec:0,G:0,S:0,OT:0,T:0},P1:{timeSec:0,G:0,S:0,OT:0,T:0},P2:{timeSec:0,G:0,S:0,OT:0,T:0}}};if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save();setTimeout(()=>{["H1","H2","P1","P2"].forEach(fitCardsToViewport)},0)// Reapply preserved durations (do NOT override user-defined values)
try {
  if(state.halves&&state.halves.H1) state.halves.H1.duration = _keepH1;
  if(state.halves&&state.halves.H2) state.halves.H2.duration = _keepH2;
  if(state.halves&&state.halves.P1) state.halves.P1.duration = _keepP1;
  if(state.halves&&state.halves.P2) state.halves.P2.duration = _keepP2;
  // Sync Definition inputs with preserved durations (in minutes)
  const s=(x)=>Math.round((x||0)/60);
  const e1=document.getElementById("defMin_H1"); if(e1) e1.value = s(_keepH1);
  const e2=document.getElementById("defMin_H2"); if(e2) e2.value = s(_keepH2);
  const e3=document.getElementById("defMin_P1"); if(e3) e3.value = s(_keepP1);
  const e4=document.getElementById("defMin_P2"); if(e4) e4.value = s(_keepP2);
} catch(_) {}// --- ensure no player selected on ALL cards after reset (clear lineup + UI) ---
try {
  state.lineup = {};
  const prefixes = ["H1","H2","P1","P2"];
  const slots = ["GK","F1","F2","F3","F4"];
  prefixes.forEach(pref=>{
    slots.forEach(k=>{
      const nameEl = document.getElementById(`${pref}_${k}Name`);
      const avatarEl = document.getElementById(`${pref}_${k}Avatar`);
      const statsEl = document.getElementById(`${pref}_${k}Stats`);
      const timeEl = document.getElementById(`${pref}_${k}Time`);
      if(nameEl) nameEl.value = "";
      if(avatarEl) avatarEl.textContent = "?";
      if(statsEl) statsEl.innerHTML = "";
      if(timeEl) timeEl.textContent = "0m 0s";
    });
  });
  paintAll();
  save();
} catch(e) {}
// --- end clear selection ---
};
    document.getElementById("exportBtn").onclick=()=>{const csv=toCSV();const fname=(state.matchName||"jogo")+" - stats.csv";download(fname,csv)};
    function isTempoVisible(){return document.getElementById("pageTempo").style.display!=="none"}
    function setAvatarEl(el,p){if(p&&p.photo){el.style.backgroundImage=`url('${p.photo}')`;el.textContent=""}else{el.style.backgroundImage="none";const letter=(p&&p.name?p.name.trim()[0]:"?")||"?";el.textContent=letter.toUpperCase()}}
    function setAvatarPhoto(el,photo,letter){if(photo){el.style.backgroundImage=`url('${photo}')`;el.textContent=""}else{el.style.backgroundImage="none";el.textContent=(letter||"?").toUpperCase()}}
    function setAvatarFromPhoto(el,photo,fb){if(photo){el.style.backgroundImage=`url('${photo}')`;el.textContent=""}else{el.style.backgroundImage="none";el.textContent=fb||"?"}}
    function fileToResizedDataURL(file,maxSize=512,mime="image/jpeg",quality=.85){return new Promise((res,rej)=>{const fr=new FileReader();fr.onerror=rej;fr.onload=()=>{const img=new Image();img.onload=()=>{const c=document.createElement("canvas");let{width,height}=img;const s=Math.min(1,maxSize/Math.max(width,height));width=Math.round(width*s);height=Math.round(height*s);c.width=width;c.height=height;const ctx=c.getContext("2d");ctx.drawImage(img,0,0,width,height);try {  if(mime === "image/png"){    res(c.toDataURL("image/png"));  } else {    res(c.toDataURL("image/jpeg", quality));  }} catch(e){ rej(e) }};img.onerror=rej;img.src=fr.result};fr.readAsDataURL(file)})}
    async function pickPhoto(cb){const input=document.createElement("input");input.type="file";input.accept="image/png,image/jpeg";input.onchange=async ()=>{  const f=input.files && input.files[0];  if(!f) return;  try {    const isPng = f.type === "image/png";    const data = await fileToResizedDataURL(f, 640, isPng ? "image/png" : "image/jpeg", .95);    cb(data);    save();  } catch(e){    alert("Falha ao carregar a imagem.");  }};input.click();}
    function teamProfileCard(){const card=document.createElement("div");card.className="card team";const top=document.createElement("div");top.className="avatarRow";const av=document.createElement("div");av.className="avatar lg";setAvatarPhoto(av,state.team.photo,(state.team.name||"N")[0]);top.appendChild(av);const nameRow=document.createElement("div");nameRow.className="name";nameRow.style.flex=1;const input=document.createElement("input");input.value=state.team.name||"Minha Equipa";input.onchange=()=>{state.team.name=input.value.trim()||"Minha Equipa";if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()};nameRow.appendChild(input);top.appendChild(nameRow);card.appendChild(top);const actions=document.createElement("div");actions.className="avatarRow";const btnFoto=document.createElement("button");btnFoto.className="ghost avatarBtn";btnFoto.textContent="Foto";btnFoto.onclick=()=>pickPhoto(d=>{state.team.photo=d;paintAll()});const btnDelFoto=document.createElement("button");btnDelFoto.className="ghost avatarBtn";btnDelFoto.textContent="Remover foto";btnDelFoto.onclick=()=>{state.team.photo=null;if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()};actions.appendChild(btnFoto);actions.appendChild(btnDelFoto);card.appendChild(actions);return card}
    function opponentProfileCard(){const card=document.createElement("div");card.className="card opponent";const top=document.createElement("div");top.className="avatarRow";const av=document.createElement("div");av.className="avatar lg";setAvatarFromPhoto(av,state.opponent.photo,"A");top.appendChild(av);const nameRow=document.createElement("div");nameRow.className="name";nameRow.style.flex=1;const input=document.createElement("input");input.value=state.opponent.name||"Advers√°ria";input.onchange=()=>{state.opponent.name=input.value.trim()||"Advers√°ria";if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()};nameRow.appendChild(input);top.appendChild(nameRow);card.appendChild(top);const actions=document.createElement("div");actions.className="avatarRow";const btnFoto=document.createElement("button");btnFoto.className="ghost avatarBtn";btnFoto.textContent="Foto";btnFoto.onclick=()=>pickPhoto(d=>{state.opponent.photo=d;paintAll()});const btnDelFoto=document.createElement("button");btnDelFoto.className="ghost avatarBtn";btnDelFoto.textContent="Remover foto";btnDelFoto.onclick=()=>{state.opponent.photo=null;if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()};actions.appendChild(btnFoto);actions.appendChild(btnDelFoto);card.appendChild(actions);return card}
    function profileCard(p){const card=document.createElement("div");card.className="card "+(p.role===roles.GK?"gk":"field");const top=document.createElement("div");top.className="avatarRow";const av=document.createElement("div");av.className="avatar lg";setAvatarEl(av,p);top.appendChild(av);const nameRow=document.createElement("div");nameRow.className="name";nameRow.style.flex=1;const input=document.createElement("input");input.value=p.name;input.placeholder=p.role===roles.GK?"Guarda‚Äëredes":"Atleta";input.onchange=()=>{p.name=input.value.trim()||p.name;if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()};nameRow.appendChild(input);const num=document.createElement("input");num.value=p.number||"";num.placeholder="N¬∫";num.type="number";num.min="0";num.inputMode="numeric";num.style.width="72px";num.style.maxWidth="72px";num.onchange=()=>{p.number=(num.value||"").trim();save()};nameRow.appendChild(num);top.appendChild(nameRow);card.appendChild(top);const actions=document.createElement("div");actions.className="avatarRow";const sel=document.createElement("select");sel.className="roleSel";sel.innerHTML=`<option value="F"${p.role===roles.F?" selected":""}>Campo</option><option value="GK"${p.role===roles.GK?" selected":""}>GR</option>`;sel.onchange=()=>{p.role=sel.value;if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()};actions.appendChild(sel);const btnFoto=document.createElement("button");btnFoto.className="ghost avatarBtn";btnFoto.textContent="Foto";btnFoto.onclick=()=>pickPhoto(d=>{p.photo=d;paintAll()});actions.appendChild(btnFoto);const btnDelFoto=document.createElement("button");btnDelFoto.className="ghost avatarBtn";btnDelFoto.textContent="Remover foto";btnDelFoto.onclick=()=>{p.photo=null;if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()};actions.appendChild(btnDelFoto);const del=document.createElement("button");del.className="ghost";del.textContent="Remover perfil";del.onclick=()=>{if(Object.values(state.lineup).includes(p.id)){alert("Este perfil est√° no alinhamento. Substitui primeiro antes de remover.");return}state.profiles=state.profiles.filter(x=>x.id!==p.id);if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()};actions.appendChild(del);card.appendChild(actions);return card}
    function paintProfiles(){const grid=document.getElementById("profilesGrid");grid.innerHTML="";grid.appendChild(teamProfileCard());grid.appendChild(opponentProfileCard());for(const p of state.profiles)grid.appendChild(profileCard(p));document.getElementById("addFieldBtn").onclick=()=>{state.profiles.push(newProfile("",roles.F));paintProfiles();save()};document.getElementById("addGKBtn").onclick=()=>{state.profiles.push(newProfile("",roles.GK));paintProfiles();save()}}
    function setupRAF(){function loop(){const now=performance.now();for(const half of HALVES){const t=state.halves[half];if(!t.running){updatePanelPaused(half,true);continue}const elapsedMs=t.elapsedBeforeMs+(t.startedAtMs?(now-t.startedAtMs):0);const elapsedSec=Math.floor(elapsedMs/1e3);if(elapsedSec>t.lastCountedSec){const delta=elapsedSec-t.lastCountedSec;t.lastCountedSec=elapsedSec;for(const k of["GK","F1","F2","F3","F4"]){const id=state.lineup[k];if(!id)continue;const p=state.profiles.find(x=>x.id===id);if(!p)continue;p.parts[half].timeSec=(p.parts[half].timeSec||0)+delta; p.parts[half].sessionSec=(p.parts[half].sessionSec||0)+delta}if(isFivevFourActive()){state.fivevfour.timeSec+=delta;state.fivevfour.parts[half].timeSec+=delta}updateAllTimeBadges();save();if(isTempoVisible()){buildFivev4Box();buildTimeTable()}}updateTimerDisplay(half);updatePanelPaused(half,false)}requestAnimationFrame(loop)}requestAnimationFrame(loop)}
    function remainingSeconds(half){const t=state.halves[half];const now=performance.now();const elapsedMs=t.elapsedBeforeMs+(t.running&&t.startedAtMs?(now-t.startedAtMs):0);const remain=Math.max(0,t.duration-Math.floor(elapsedMs/1e3));return remain}
    function secondsToMMSS(s){s=Math.max(0,Math.floor(s));const m=Math.floor(s/60),sec=s%60;return (m+"").padStart(2,"0")+":"+(sec+"").padStart(2,"0")}
    
    function fmtMinShort(sec){ sec=Math.max(0,sec)|0; const m=Math.floor(sec/60); const s=sec%60; return m+"m "+s+"s"; }
    function setTimeBadge(elId, sec){ const el=document.getElementById(elId); if(el) el.textContent = fmtMinShort(sec||0); }
    function updateAllTimeBadges(){
  // helper para aplicar classes de aviso/alerta
  function applyBadgeClass(el, sec){
    if(!el) return;
    if(sec > 480){
      el.classList.add("alert");
      el.classList.remove("warn");
    }else if(sec > 300){
      el.classList.add("warn");
      el.classList.remove("alert");
    }else{
      el.classList.remove("warn");
      el.classList.remove("alert");
    }
  }

  ["H1","H2","P1","P2"].forEach(h=>{
    // GR
    const g = lineupProfile("GK"); const show = state.halves[h].running; const gSec = (show && g && g.parts && g.parts[h]) ? (g.parts[h].sessionSec||0) : 0; setTimeBadge(h+"_gkTime", gSec); applyBadgeClass(document.getElementById(h+"_gkTime"), gSec);

    // Jogadores de campo (F1‚ÄìF4)
    ["F1","F2","F3","F4"].forEach(k=>{
      const p = lineupProfile(k); const id = `${h}_${k}Time`; const show = state.halves[h].running; const sec = (show && p && p.parts && p.parts[h]) ? (p.parts[h].sessionSec||0) : 0; setTimeBadge(id, sec); applyBadgeClass(document.getElementById(id), sec);
    });
  });
}

    function updateTimerDisplay(half){const el=document.getElementById("timerDisplay_"+half);if(el)el.textContent=secondsToMMSS(remainingSeconds(half))}
    function toggleTimer(half){
  // Ensure only one global timer; and reset badge sessions if switching back to this half
  try {
    const keys=["H1","H2","P1","P2"];
    const isStarting = !state.halves[half].running;
    if(isStarting){
      // stop all other running halves
      keys.filter(k=>k!==half).forEach(k=>{
        const o=state.halves[k];
        if(o && o.running){
          const now=performance.now();
          o.elapsedBeforeMs += (o.startedAtMs ? (now - o.startedAtMs) : 0);
          o.startedAtMs=null;
          o.running=false;
          if(typeof updatePanelPaused==="function") updatePanelPaused(k,true);
        }
      });
      // If we are switching from a different active half, reset session badges for this half
      if(state.activeHalf!==half && typeof resetSessionForHalf==="function"){
        resetSessionForHalf(half);
      }
    }
  } catch(e) {}
const t=state.halves[half];if(t.running){const now=performance.now();t.elapsedBeforeMs+=t.startedAtMs?(now-t.startedAtMs):0;t.startedAtMs=null;t.running=false}else{const other=half==="H1"?"H2":"H1";if(state.halves[other].running){const now=performance.now();const o=state.halves[other];o.elapsedBeforeMs+=o.startedAtMs?(now-o.startedAtMs):0;o.startedAtMs=null;o.running=false}t.startedAtMs=performance.now();t.running=true; state.activeHalf=half}updatePanelPaused(half,!state.halves[half].running);save()}
    
    function resetSessionForHalf(half){ for(const p of state.profiles){ if(p.parts && p.parts[half]) p.parts[half].sessionSec = 0; } }
function resetTimer(half){const t=state.halves[half];t.running=false;t.startedAtMs=null;t.elapsedBeforeMs=0;t.lastCountedSec=0;updateTimerDisplay(half);updatePanelPaused(half,true);resetSessionForHalf(half);save()}
    function updatePanelPaused(half,paused){const panel=document.getElementById("panel_"+half);if(!panel)return;panel.classList.toggle("paused",paused);panel.classList.toggle("green",(half==="H1"||half==="P1")&&!paused);panel.classList.toggle("orange",(half==="H2"||half==="P2")&&!paused);if((half==="H1"||half==="P1")&&paused)panel.classList.remove("green");if((half==="H2"||half==="P2")&&paused)panel.classList.remove("orange")}
    function lineupProfile(slotKey){const id=state.lineup[slotKey];return state.profiles.find(p=>p.id===id)||null}
    function setLineup(slotKey,profileId){const prevId=state.lineup[slotKey];state.lineup[slotKey]=profileId;if(prevId!==profileId){const pl=state.profiles.find(p=>p.id===profileId);if(pl)pl.entries=(pl.entries||0)+1}if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}  paintAll();updateAllTimeBadges();const plNew = state.profiles.find(p=>p.id===profileId);const active = ["H1","H2","P1","P2"].find(h=>state.halves[h] && state.halves[h].running);if(plNew && active && plNew.parts && plNew.parts[active]) plNew.parts[active].sessionSec = 0;save();setTimeout(()=>{["H1","H2","P1","P2"].forEach(fitCardsToViewport)},0)}
    function openPicker(btnEl,roleFilter,slotKey){const listEl=btnEl.nextElementSibling;if(listEl.classList.contains("open")){listEl.classList.remove("open");return}listEl.innerHTML="";const used=new Set(Object.values(state.lineup));const current=state.lineup[slotKey];const candidates=state.profiles.filter(p=>(!roleFilter||p.role===roleFilter)&&!used.has(p.id));for(const p of candidates){const div=document.createElement("div");div.textContent=p.name+(p.role===roles.GK?" (GR)":" (Campo)");div.onclick=()=>{try{setLineup(slotKey,p.id)}catch(_){state.lineup=state.lineup||{};state.lineup[slotKey]=p.id}listEl.classList.remove("open");paintAll();save();};listEl.appendChild(div)}listEl.classList.add("open");
  // --- iPad-friendly: float list as FIXED overlay and ensure full scroll ---
  try {
    const btnRect = btnEl.getBoundingClientRect();
    const vw = window.innerWidth || document.documentElement.clientWidth || 0;
    const vh = window.innerHeight || document.documentElement.clientHeight || 0;
    listEl.style.position = "fixed";
    listEl.style.zIndex = "9999";
    listEl.style.display = "block";
    listEl.style.webkitOverflowScrolling = "touch";
    listEl.style.overflowY = "auto";
    const maxH = Math.max(220, Math.floor(vh * 0.6));
    const width = Math.min(320, Math.max(240, Math.floor(vw * 0.45)));
    listEl.style.maxHeight = maxH + "px";
    listEl.style.width = width + "px";
    const spaceBelow = vh - btnRect.bottom - 8;
    const openDown = spaceBelow >= Math.min(maxH, 180);
    const top = openDown ? (btnRect.bottom + 6) : Math.max(8, btnRect.top - maxH - 6);
    let left = btnRect.left;
    if (left + width + 8 > vw) left = Math.max(8, vw - width - 8);
    listEl.style.top = top + "px";
    listEl.style.left = left + "px";
    listEl.style.right = "auto";
  } catch (e) {}
  // --- end iPad-friendly overlay ---
const close=e=>{if(!listEl.contains(e.target)&&e.target!==btnEl){listEl.classList.remove("open");document.removeEventListener("click",close)}};setTimeout(()=>document.addEventListener("click",close),0)}
    function statRecalcTotalsFromParts(p){for(const key of["S","OT","T","G","GA","SV","PC","PF","FO","YC","RC"]){const h1=p.parts?.H1?.[key]||0,h2=p.parts?.H2?.[key]||0;p[key]=Math.max(0,h1+h2)}}
    function statIncProfileHalf(p,key,delta,half){p.parts[half][key]=Math.max(0,(p.parts[half][key]||0)+delta);statRecalcTotalsFromParts(p)}
    function oppRecalcTotals(){for(const k of["G","S","OT","T","FO","YC","RC"]){state.opponent[k]=Math.max(0,(state.opponent.parts.H1[k]||0)+(state.opponent.parts.H2[k]||0)+(state.opponent.parts.P1[k]||0)+(state.opponent.parts.P2[k]||0))}}
    function oppIncHalf(key,delta,half){state.opponent.parts[half][key]=Math.max(0,(state.opponent.parts[half][key]||0)+delta);oppRecalcTotals()}
    function isFivevFourActive(){const p=lineupProfile("GK");return !!p&&p.role===roles.F}
    function fivev4Action(half,key,delta){state.fivevfour.parts[half][key]=Math.max(0,(state.fivevfour.parts[half][key]||0)+delta)}
    function ourFoulsByHalf(half){let sum=0;for(const p of state.profiles){sum+=(p.parts[half].FO||0)}return sum}
    function mkOpponentCard(prefix){const c=document.createElement("div");c.className="card opponent";c.innerHTML=`
        <div class="avatarRow">
          <div class="avatar" id="${prefix}_oppAvatar">A</div>
          <div class="name" style="flex:1"><input id="${prefix}_oppName" /></div>
        </div>
        <div class="stats field">
          <div class="stat"><label>Golos</label><div class="count" id="${prefix}_opp_G">0</div><button class="plus" data-scope="OPP" data-half="${prefix}" data-key="G">+</button><button class="minus" data-scope="OPP" data-half="${prefix}" data-key="G">‚àí</button></div>
          <div class="stat"><label>Remates</label><div class="count" id="${prefix}_opp_S">0</div><button class="plus" data-scope="OPP" data-half="${prefix}" data-key="S">+</button><button class="minus" data-scope="OPP" data-half="${prefix}" data-key="S">‚àí</button></div>
          <div class="stat"><label>Baliza</label><div class="count" id="${prefix}_opp_OT">0</div><button class="plus" data-scope="OPP" data-half="${prefix}" data-key="OT">+</button><button class="minus" data-scope="OPP" data-half="${prefix}" data-key="OT">‚àí</button></div>
          <div class="stat"><label>Desarmes</label><div class="count" id="${prefix}_opp_T">0</div><button class="plus" data-scope="OPP" data-half="${prefix}" data-key="T">+</button><button class="minus" data-scope="OPP" data-half="${prefix}" data-key="T">‚àí</button></div>
        </div>`;return c}
    function mkGKCard(prefix){const c=document.createElement("div");c.className="card gk";c.innerHTML=`
        <div class="avatarRow">
          <div class="avatar" id="${prefix}_gkAvatar">?</div>
          <div class="name" style="flex:1"><input id="${prefix}_gkName" placeholder="Guarda‚Äëredes ou 5x4" /></div>
          <div class="timeBadge" id="${prefix}_gkTime">0,0m</div>
          <div class="picker">
            <button id="${prefix}_gkPickBtn" class="ghost">Substituir</button>
            <div id="${prefix}_gkPickList" class="pickerList"></div>
          </div>
        </div>
        <div id="${prefix}_gkStatsWrap"></div>`;return c}
    function mkFieldCard(prefix,slotKey){const c=document.createElement("div");c.className="card field";c.innerHTML=`
        <div class="avatarRow">
          <div class="avatar" id="${prefix}_${slotKey}Avatar">?</div>
          <div class="name" style="flex:1"><input id="${prefix}_${slotKey}Name" placeholder="Atleta" /></div>
          <div class="timeBadge" id="${prefix}_${slotKey}Time">0,0m</div>
          <div class="picker">
            <button id="${prefix}_${slotKey}PickBtn" class="ghost">Substituir</button>
            <div id="${prefix}_${slotKey}PickList" class="pickerList"></div>
          </div>
        </div>
        <div class="stats field" id="${prefix}_${slotKey}Stats"></div>`;return c}
    function buildHalfLayout(half){const topGrid=document.getElementById(half==="H1"?"h1GridTop":(half==="H2"?"h2GridTop":(half==="P1"?"p1GridTop":"p2GridTop")));const midGrid=document.getElementById(half==="H1"?"h1GridMid":(half==="H2"?"h2GridMid":(half==="P1"?"p1GridMid":"p2GridMid")));const botGrid=document.getElementById(half==="H1"?"h1GridBot":(half==="H2"?"h2GridBot":(half==="P1"?"p1GridBot":"p2GridBot")));topGrid.innerHTML="";midGrid.innerHTML="";botGrid.innerHTML="";const pref=half;topGrid.appendChild(mkOpponentCard(pref));topGrid.appendChild(mkGKCard(pref));midGrid.appendChild(mkFieldCard(pref,"F1"));midGrid.appendChild(mkFieldCard(pref,"F2"));botGrid.appendChild(mkFieldCard(pref,"F3"));botGrid.appendChild(mkFieldCard(pref,"F4"));document.getElementById(`${pref}_gkPickBtn`).onclick=e=>openPicker(e.target,null,"GK");["F1","F2","F3","F4"].forEach(k=>{document.getElementById(`${pref}_${k}PickBtn`).onclick=e=>openPicker(e.target,roles.F,k)});paintHalf(half);document.getElementById("toggleTimerBtn_"+half).onclick=()=>toggleTimer(half);buildMiniFouls(half);setTimeout(()=>fitCardsToViewport(half),0)}
    function applyCountsToUI_Field(prefix,p,half,cum){function set(id,val){const el=document.getElementById(`${prefix}_${id}`);if(el)el.textContent=val||0}if(!p){["G","S","OT","T"].forEach(id=>set(id,0));return}const base=cum?{G:(p.parts.H1.G||0)+(p.parts.H2.G||0),S:(p.parts.H1.S||0)+(p.parts.H2.S||0),OT:(p.parts.H1.OT||0)+(p.parts.H2.OT||0),T:(p.parts.H1.T||0)+(p.parts.H2.T||0)}:p.parts[half];set("G",base.G||0);set("S",base.S||0);set("OT",base.OT||0);set("T",base.T||0)}
    function applyCountsToUI_GK(prefix,p,half,cum){function set(id,val){const el=document.getElementById(`${prefix}_${id}`);if(el)el.textContent=val||0}if(!p)return;if(p.role===roles.GK){const base=cum?{GA:(p.parts.H1.GA||0)+(p.parts.H2.GA||0),SV:(p.parts.H1.SV||0)+(p.parts.H2.SV||0),PC:(p.parts.H1.PC||0)+(p.parts.H2.PC||0),PF:(p.parts.H1.PF||0)+(p.parts.H2.PF||0),S:(p.parts.H1.S||0)+(p.parts.H2.S||0)}:p.parts[half];set("GA",base.GA||0);set("SV",base.SV||0);set("PC",base.PC||0);set("PF",base.PF||0);set("S",base.S||0)}else{const base=cum?{G:(p.parts.H1.G||0)+(p.parts.H2.G||0),S:(p.parts.H1.S||0)+(p.parts.H2.S||0),OT:(p.parts.H1.OT||0)+(p.parts.H2.OT||0),T:(p.parts.H1.T||0)+(p.parts.H2.T||0)}:p.parts[half];set("G",base.G||0);set("S",base.S||0);set("OT",base.OT||0);set("T",base.T||0)}}
    function bindButtons_Field(prefix,p,half,scope){document.querySelectorAll('button[data-scope="'+scope+'"][data-prefix="'+prefix+'"]').forEach(btn=>{btn.onclick=()=>{if(!p)return;const key=btn.getAttribute("data-key");const delta=btn.classList.contains("plus")?1:-1;const map={G:"G",S:"S",OT:"OT",T:"T"};const stKey=map[key];statIncProfileHalf(p,stKey,delta,half);if(stKey==="G"){if(delta>0)state.score.us+=1;else state.score.us=Math.max(0,state.score.us-1)}if(isFivevFourActive())fivev4Action(half,stKey,delta);applyCountsToUI_Field(prefix,p,half,(half==="H2"||half==="P2"));updateScoreboards();buildMiniFouls(half);if(isTempoVisible())buildTimeTable();save()}})}
    function bindButtons_GK(prefix,p,half){
  // GK-specific stats
  document.querySelectorAll('button[data-scope="GK"][data-prefix="'+prefix+'"]').forEach(btn=>{
    btn.onclick=()=>{
      if(!p) return;
      const key=btn.getAttribute("data-key");
      const delta=btn.classList.contains("plus")?1:-1;
      statIncProfileHalf(p,key,delta,half);
      if(key==="GA"){
        if(delta>0){ state.score.them+=1; oppIncHalf("G",+1,half); }
        else { state.score.them=Math.max(0,state.score.them-1); oppIncHalf("G",-1,half); }
      }
      applyCountsToUI_GK(prefix,p,half,(half==="H2"||half==="P2"));
      paintOpponentHalf(half);
      updateScoreboards(); buildMiniFouls(half);
      if(isTempoVisible()) buildTimeTable();
      save();
    };
  });
  // Field-mode while in GK slot (5x4)
  const prefix2 = prefix.replace("_gk","_gkf");
  document.querySelectorAll('button[data-scope="GKF"][data-prefix="'+prefix2+'"]').forEach(btn=>{
    btn.onclick=()=>{
      if(!p) return;
      const key=btn.getAttribute("data-key");
      const delta=btn.classList.contains("plus")?1:-1;
      statIncProfileHalf(p,key,delta,half);
      if(key==="G"){
        if(delta>0) state.score.us+=1;
        else state.score.us=Math.max(0,state.score.us-1);
      }
      if(isFivevFourActive()) fivev4Action(half,key,delta);
      applyCountsToUI_GK(prefix,p,half,(half==="H2"||half==="P2"));
      updateScoreboards(); buildMiniFouls(half);
      if(isTempoVisible()) buildTimeTable();
      save();
    };
  });
}
    function paintOpponentHalf(half){const cum=(half==="H2"||half==="P2");const pref=half;const nameEl=document.getElementById(`${pref}_oppName`);if(nameEl){nameEl.value=state.opponent.name||"Advers√°ria";nameEl.onchange=()=>{state.opponent.name=nameEl.value.trim()||"Advers√°ria";if(!state.halves.P1){state.halves.P1={duration:state.halves.H1.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:state.halves.H2.duration,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}paintAll();save()}}for(const k of["G","S","OT","T"]){const el=document.getElementById(`${pref}_opp_${k}`);if(!el)continue;const val=cum?(state.opponent.parts.H1[k]||0)+(state.opponent.parts.H2[k]||0):(state.opponent.parts[half][k]||0);el.textContent=val}const av=document.getElementById(`${pref}_oppAvatar`);if(av)setAvatarFromPhoto(av,state.opponent.photo,"A");document.querySelectorAll('button[data-scope="OPP"][data-half="'+pref+'"]').forEach(btn=>{const key=btn.getAttribute("data-key");btn.onclick=()=>{const delta=btn.classList.contains("plus")?1:-1;oppIncHalf(key,delta,half);if(key==="G"){const gk=lineupProfile("GK");if(delta>0){state.score.them+=1;if(gk){statIncProfileHalf(gk,"GA",+1,half)}}else{state.score.them=Math.max(0,state.score.them-1);if(gk&&(gk.parts[half].GA||0)>0){statIncProfileHalf(gk,"GA",-1,half)}}paintGKHalf("H1");paintGKHalf("H2")}paintOpponentHalf(half);updateScoreboards();buildMiniFouls(half);if(isTempoVisible())buildTimeTable();save()}})}
    function buildFieldStatsHTML(prefix,scope){return `<div class="stat"><label>Golos</label><div class="count" id="${prefix}_G">0</div><button class="plus" data-scope="${scope}" data-prefix="${prefix}" data-key="G">+</button><button class="minus" data-scope="${scope}" data-prefix="${prefix}" data-key="G">‚àí</button></div><div class="stat"><label>Remates</label><div class="count" id="${prefix}_S">0</div><button class="plus" data-scope="${scope}" data-prefix="${prefix}" data-key="S">+</button><button class="minus" data-scope="${scope}" data-prefix="${prefix}" data-key="S">‚àí</button></div><div class="stat"><label>Baliza</label><div class="count" id="${prefix}_OT">0</div><button class="plus" data-scope="${scope}" data-prefix="${prefix}" data-key="OT">+</button><button class="minus" data-scope="${scope}" data-prefix="${prefix}" data-key="OT">‚àí</button></div><div class="stat"><label>Desarmes</label><div class="count" id="${prefix}_T">0</div><button class="plus" data-scope="${scope}" data-prefix="${prefix}" data-key="T">+</button><button class="minus" data-scope="${scope}" data-prefix="${prefix}" data-key="T">‚àí</button></div>`}
    function buildGKStatsHalfHTML(prefix,p){if(!p||p.role===roles.GK){return `<div class="stats"><div class="stat"><label>GOLOS SOFRIDOS</label><div class="count" id="${prefix}_GA">0</div><button class="plus" data-scope="GK" data-prefix="${prefix}" data-key="GA">+</button><button class="minus" data-scope="GK" data-prefix="${prefix}" data-key="GA">‚àí</button></div><div class="stat"><label>Defesas</label><div class="count" id="${prefix}_SV">0</div><button class="plus" data-scope="GK" data-prefix="${prefix}" data-key="SV">+</button><button class="minus" data-scope="GK" data-prefix="${prefix}" data-key="SV">‚àí</button></div><div class="stat"><label>Passes ‚úì</label><div class="count" id="${prefix}_PC">0</div><button class="plus" data-scope="GK" data-prefix="${prefix}" data-key="PC">+</button><button class="minus" data-scope="GK" data-prefix="${prefix}" data-key="PC">‚àí</button></div><div class="stat"><label>Passes ‚úó</label><div class="count" id="${prefix}_PF">0</div><button class="plus" data-scope="GK" data-prefix="${prefix}" data-key="PF">+</button><button class="minus" data-scope="GK" data-prefix="${prefix}" data-key="PF">‚àí</button></div><div class="stat"><label>Remates</label><div class="count" id="${prefix}_S">0</div><button class="plus" data-scope="GK" data-prefix="${prefix}" data-key="S">+</button><button class="minus" data-scope="GK" data-prefix="${prefix}" data-key="S">‚àí</button></div></div>`}else{return `<div class="stats field">`+buildFieldStatsHTML(prefix.replace("_gk","_gkf"),"GKF")+`</div>`}}
    function paintGKHalf(half){
  const cum = (half==="H2"||half==="P2");
  const pref = half+"_gk";
  const pGK = lineupProfile("GK");
  const nameEl = document.getElementById(`${pref}Name`);
  const avEl = document.getElementById(`${pref}Avatar`);
  if(nameEl) nameEl.value = pGK ? pGK.name : "";
  if(avEl) setAvatarEl(avEl, pGK);
  const wrap = document.getElementById(`${pref}StatsWrap`);
  if(wrap){
    wrap.innerHTML = buildGKStatsHalfHTML(pref, pGK);
    // Delegated click handler for any newly-rendered GK/GKF buttons
    wrap.onclick = (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const scope = btn.getAttribute('data-scope');
      const key = btn.getAttribute('data-key');
      if(!scope || !key) return;
      const player = lineupProfile("GK");
      if(!player) return;
      const delta = btn.classList.contains('plus') ? 1 : btn.classList.contains('minus') ? -1 : 0;
      if(!delta) return;

      if(scope === "GK"){
        statIncProfileHalf(player, key, delta, half);
        if(key==="GA"){
          if(delta>0){ state.score.them+=1; oppIncHalf("G",+1,half); }
          else { state.score.them=Math.max(0,state.score.them-1); oppIncHalf("G",-1,half); }
        }
      }else if(scope === "GKF"){
        statIncProfileHalf(player, key, delta, half);
        if(key==="G"){
          if(delta>0) state.score.us+=1;
          else state.score.us=Math.max(0,state.score.us-1);
        }
        if(isFivevFourActive()) fivev4Action(half,key,delta);
      }
      // Update the exact counter in this GK card immediately
      const gkfPrefix = pref.replace("_gk","_gkf");
      const countId = scope==="GKF" ? `${gkfPrefix}_${key}` : `${pref}_${key}`;
      const el = document.getElementById(countId);
      if(el){
        // compute display value (cum for H2)
        let val = 0;
        if(scope==="GKF"){
          val = (cum ? (player.parts.H1[key]||0)+(player.parts.H2[key]||0) : (player.parts[half][key]||0));
        }else{
          val = (cum ? (player.parts.H1[key]||0)+(player.parts.H2[key]||0) : (player.parts[half][key]||0));
        }
        el.textContent = val;
      }
      applyCountsToUI_GK(pref, player, half, cum);
      if(scope==="GK") paintOpponentHalf(half);
      updateScoreboards(); buildMiniFouls(half);
      if(isTempoVisible()) buildTimeTable();
      save();
    };
  }
  if(document.getElementById(`${pref}PickBtn`)) document.getElementById(`${pref}PickBtn`).onclick = e => openPicker(e.target, null, "GK");
  if(pGK) applyCountsToUI_GK(pref, pGK, half, cum);
}
    function paintFieldsHalf(half){const cum=half==="H2";const pref=half;["F1","F2","F3","F4"].forEach(k=>{const p=lineupProfile(k);const av=document.getElementById(`${pref}_${k}Avatar`);if(av)setAvatarEl(av,p);const nameId=`${pref}_${k}Name`;const statsId=`${pref}_${k}Stats`;const statsWrap=document.getElementById(statsId);if(statsWrap)statsWrap.innerHTML=buildFieldStatsHTML(`${pref}_${k.toLowerCase()}`,"FIELD");const pickBtn=document.getElementById(`${pref}_${k}PickBtn`);if(pickBtn)pickBtn.onclick=e=>openPicker(e.target,roles.F,k);if(nameId)document.getElementById(nameId).value=p?p.name:"";applyCountsToUI_Field(`${pref}_${k.toLowerCase()}`,p,half,cum);if(p)bindButtons_Field(`${pref}_${k.toLowerCase()}`,p,half,"FIELD")})}
    function updateScoreboards(){applyScoreboard("H1");applyScoreboard("H2");applyScoreboard("P1");applyScoreboard("P2")}
    function applyScoreboard(half){const leftLogo=document.getElementById("leftLogo_"+half);const rightLogo=document.getElementById("rightLogo_"+half);const leftScore=document.getElementById("leftScore_"+half);const rightScore=document.getElementById("rightScore_"+half);const leftFouls=document.getElementById("leftFouls_"+half);const rightFouls=document.getElementById("rightFouls_"+half);const homeLeft=state.venue==="CASA";const foulsHalf=half;if(homeLeft){setAvatarPhoto(leftLogo,state.team.photo,(state.team.name||"N")[0]);setAvatarPhoto(rightLogo,state.opponent.photo,"A");leftScore.textContent=state.score.us;rightScore.textContent=state.score.them;leftFouls.textContent=ourFoulsByHalf(foulsHalf);rightFouls.textContent=state.opponent.parts[foulsHalf].FO||0}else{setAvatarPhoto(leftLogo,state.opponent.photo,"A");setAvatarPhoto(rightLogo,state.team.photo,(state.team.name||"N")[0]);leftScore.textContent=state.score.them;rightScore.textContent=state.score.us;leftFouls.textContent=state.opponent.parts[foulsHalf].FO||0;rightFouls.textContent=ourFoulsByHalf(foulsHalf)}}
    function paintHalf(half){paintOpponentHalf(half);paintGKHalf(half);paintFieldsHalf(half);updateAllTimeBadges();updateTimerDisplay(half);updateScoreboards();updatePanelPaused(half,!state.halves[half].running);setTimeout(()=>fitCardsToViewport(half),0)}
    function miniFoulCard(title, getAvatar, getCounts, onChange, half){
  const c = document.createElement('div'); c.className='hcard';
  const who = document.createElement('div'); who.className='who';
  const av = document.createElement('div'); av.className='avatar'; getAvatar(av); who.appendChild(av);
  const name = document.createElement('div'); name.className='hname'; name.textContent = title; who.appendChild(name);
  c.appendChild(who);

  function mkCol(labelText, key, initial){
    const col = document.createElement('div'); col.className='col';
    const top = document.createElement('div'); top.className='colTop';
    const lab = document.createElement('div'); lab.className='colLabel'; lab.textContent = labelText;
    const ct = document.createElement('div'); ct.className='colCount'; ct.textContent = initial||0;
    top.appendChild(lab); top.appendChild(ct); col.appendChild(top);
    const btns = document.createElement('div'); btns.className='colBtns';
    const plus = document.createElement('button'); plus.className='mini plus'; plus.textContent='+';
    const minus = document.createElement('button'); minus.className='mini minus'; minus.textContent='‚àí';
    plus.onclick = ()=>{ const v = onChange(key,+1); ct.textContent = v; updateScoreboards(); if(isTempoVisible()) buildTimeTable(); buildMiniFouls(half); };
    minus.onclick = ()=>{ const v = onChange(key,-1); ct.textContent = v; updateScoreboards(); if(isTempoVisible()) buildTimeTable(); buildMiniFouls(half); };
    btns.appendChild(plus); btns.appendChild(minus);
    col.appendChild(btns);
    return col;
  }

  const counts = getCounts();
  c.appendChild(mkCol('FO','FO', counts.FO||0));
  c.appendChild(mkCol('üü®','YC', counts.YC||0));
  c.appendChild(mkCol('üü•','RC', counts.RC||0));
  return c;
}
    function buildMiniFouls(half){const container=document.getElementById("miniFouls_"+half);if(!container)return;container.innerHTML="";container.appendChild(miniFoulCard("",av=>setAvatarFromPhoto(av,state.opponent.photo,"A"),()=>state.opponent.parts[half],(key,delta)=>{oppIncHalf(key,delta,half);if(key==="YC"||key==="RC"){oppIncHalf("FO",delta,half)}save();return state.opponent.parts[half][key]},half));for(const k of["GK","F1","F2","F3","F4"]){const p=lineupProfile(k);if(!p)continue;container.appendChild(miniFoulCard((p.number||""),av=>setAvatarEl(av,p),()=>p.parts[half],(key,delta)=>{statIncProfileHalf(p,key,delta,half);if(key==="YC"||key==="RC"){statIncProfileHalf(p,"FO",delta,half)}save();return p.parts[half][key]},half))}
  // Re-sincroniza alturas ap√≥s render da lista de faltas
  setTimeout(()=>fitCardsToViewport(half), 0);
}
    function buildFivev4Box(){const b=state.fivevfour,H1=b.parts.H1,H2=b.parts.H2;function fmt(sec){const mins=(Math.max(0,sec)/60).toFixed(1).replace(".",",");return `${mins} min`}const wrap=document.getElementById("fivev4Box");wrap.innerHTML=`<span class="pill">5x4 Tempo Total: ${fmt(b.timeSec)}</span><span class="pill">1¬™: ${fmt(H1.timeSec)}</span><span class="pill">2¬™: ${fmt(H2.timeSec)}</span><span class="pill">5x4 G=${H1.G+H2.G} R=${H1.S+H2.S} RB=${H1.OT+H2.OT} D=${H1.T+H2.T}</span>`}
    function avatarHtml(p){const letter=(p.name||"?")[0].toUpperCase();if(p.photo){return `<span class="avatar sm" style="background-image:url('${p.photo}')"></span>`}else{return `<span class="avatar sm">${letter}</span>`}}
    function buildTimeTable(){const wrap=document.getElementById("timeTableWrap");const filter=document.getElementById("tempoFilter").value;const rows=[];for(const p of state.profiles){const tH1=(p.parts?.H1?.timeSec||0), tH2=(p.parts?.H2?.timeSec||0), tP1=(p.parts?.P1?.timeSec||0), tP2=(p.parts?.P2?.timeSec||0);const totalAll=tH1+tH2+tP1+tP2;const entradas=p.entries||0;const stats=filter==="ALL"?p:((p.parts&&p.parts[filter])?p.parts[filter]:{});const total = filter==="ALL" ? totalAll : (p.parts?.[filter]?.timeSec||0);rows.push({prof:p,name:p.name,role:p.role,total,entradas,media:entradas>0?Math.floor(total/entradas):0,G:stats.G||0,R:stats.S||0,RB:stats.OT||0,D_DES:stats.T||0,GS:stats.GA||0,D_DEF:stats.SV||0,PC:stats.PC||0,PF:stats.PF||0,FO:stats.FO||0,YC:stats.YC||0,RC:stats.RC||0})}rows.sort((a,b)=>b.total-a.total);function fmtMin(sec){
  sec = Math.max(0, sec) | 0;
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return m + "m " + s + "s";
}let html=`<table><thead><tr><th>Jogadora</th><th>Pos.</th><th>Tempo (min)</th><th>Entradas</th><th>M√©dia (min)</th><th>G</th><th>R</th><th>RB</th><th>D</th><th>GS</th><th>D</th><th>PC</th><th>PF</th><th>FO</th><th>üü®</th><th>üü•</th></tr></thead><tbody>`;for(const r of rows){html+=`<tr><td><div class="tblName">${avatarHtml(r.prof)}<span>${escapeHtml(r.name)}</span></div></td><td>${r.role}</td><td>${fmtMin(r.total)}</td><td>${r.entradas}</td><td>${fmtMin(r.media)}</td><td>${r.G}</td><td>${r.R}</td><td>${r.RB}</td><td>${r.D_DES}</td><td>${r.GS}</td><td>${r.D_DEF}</td><td>${r.PC}</td><td>${r.PF}</td><td>${r.FO}</td><td>${r.YC}</td><td>${r.RC}</td></tr>`}html+="</tbody></table>";wrap.innerHTML=html}
    function toCSV(){const rows=[["Match","Venue","OurTeam","OppTeam","Jogadora","Pos","Tempo(s)","Entradas","M√©dia(s)","G","R","RB","D(Des)","GS","D(Def)","PC","PF","FO","YC","RC","H1_G","H1_R","H1_RB","H1_D(Des)","H1_GS","H1_D(Def)","H1_PC","H1_PF","H1_FO","H1_YC","H1_RC","H2_G","H2_R","H2_RB","H2_D(Des)","H2_GS","H2_D(Def)","H2_PC","H2_PF","H2_FO","H2_YC","H2_RC","Score_Us","Score_Them","Opp_H1_G","Opp_H1_R","Opp_H1_RB","Opp_H1_D","Opp_H1_FO","Opp_H1_YC","Opp_H1_RC","Opp_H2_G","Opp_H2_R","Opp_H2_RB","Opp_H2_D","Opp_H2_FO","Opp_H2_YC","Opp_H2_RC","Opp_Total_G","Opp_Total_R","Opp_Total_D","Opp_Total_RB","Opp_Total_FO","Opp_Total_YC","Opp_Total_RC","5x4_Time","5x4_H1_Time","5x4_H2_Time","5x4_G","5x4_R","5x4_RB","5x4_D"]];const b=state.fivevfour,H1b=b.parts.H1,H2b=b.parts.H2;for(const p of state.profiles){const P1=p.parts?.H1||{};const P2=p.parts?.H2||{};const ALL={G:p.G||0,R:p.S||0,RB:p.OT||0,D_DES:p.T||0,GS:p.GA||0,D_DEF:p.SV||0,PC:p.PC||0,PF:p.PF||0,FO:p.FO||0,YC:p.YC||0,RC:p.RC||0};const _t=(p.parts?.H1?.timeSec||0)+(p.parts?.H2?.timeSec||0)+(p.parts?.P1?.timeSec||0)+(p.parts?.P2?.timeSec||0);rows.push([state.matchName,state.venue,state.team.name,state.opponent.name,p.name,p.role,_t,p.entries||0,(p.entries?Math.floor(_t/p.entries):0),ALL.G,ALL.R,ALL.RB,ALL.D_DES,ALL.GS,ALL.D_DEF,ALL.PC,ALL.PF,ALL.FO,ALL.YC,ALL.RC,P1.G||0,P1.S||0,P1.OT||0,P1.T||0,P1.GA||0,P1.SV||0,P1.PC||0,P1.PF||0,P1.FO||0,P1.YC||0,P1.RC||0,P2.G||0,P2.S||0,P2.OT||0,P2.T||0,P2.GA||0,P2.SV||0,P2.PC||0,P2.PF||0,P2.FO||0,P2.YC||0,P2.RC||0,state.score.us,state.score.them,state.opponent.parts.H1.G||0,state.opponent.parts.H1.S||0,state.opponent.parts.H1.OT||0,state.opponent.parts.H1.T||0,state.opponent.parts.H1.FO||0,state.opponent.parts.H1.YC||0,state.opponent.parts.H1.RC||0,state.opponent.parts.H2.G||0,state.opponent.parts.H2.S||0,state.opponent.parts.H2.OT||0,state.opponent.parts.H2.T||0,state.opponent.parts.H2.FO||0,state.opponent.parts.H2.YC||0,state.opponent.parts.H2.RC||0,state.opponent.G,state.opponent.S,state.opponent.OT,state.opponent.T,state.opponent.FO,state.opponent.YC,state.opponent.RC,b.timeSec,H1b.timeSec,H2b.timeSec,(H1b.G+H2b.G),(H1b.S+H2b.S),(H1b.OT+H2b.OT),(H1b.T+H2b.T)])}return rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n")}
    function download(filename,text){const a=document.createElement("a");a.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(text));a.setAttribute("download",filename);document.body.appendChild(a);a.click();a.remove()}
    function escapeHtml(str){return String(str).replace(/[&<>\"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]))}
    document.getElementById("applyDefsBtn").onclick=()=>{const m1=Math.max(1,parseInt(document.getElementById("defMin_H1").value||"20",10));const m2=Math.max(1,parseInt(document.getElementById("defMin_H2").value||"20",10));const mp1=Math.max(1,parseInt((document.getElementById("defMin_P1")?document.getElementById("defMin_P1").value:"20")||"20",10));const mp2=Math.max(1,parseInt((document.getElementById("defMin_P2")?document.getElementById("defMin_P2").value:"20")||"20",10));state.halves.H1.duration=m1*60;state.halves.H2.duration=m2*60;if(!state.halves.P1){state.halves.P1={duration:mp1*60,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}if(!state.halves.P2){state.halves.P2={duration:mp2*60,running:false,startedAtMs:null,elapsedBeforeMs:0,lastCountedSec:0}}state.halves.P1.duration=mp1*60;state.halves.P2.duration=mp2*60;state.venue=document.getElementById("venueSel").value||"CASA";["H1","H2","P1","P2"].forEach(h=>{resetTimer(h);updateTimerDisplay(h);resetSessionForHalf(h)});updateScoreboards();save();alert("Defini√ß√µes aplicadas.");setTimeout(()=>{["H1","H2","P1","P2"].forEach(fitCardsToViewport)},0)};
    document.getElementById("resetH1Btn").onclick=()=>{if(confirm("Reset tempo 1¬™ parte?"))resetTimer("H1");setTimeout(()=>fitCardsToViewport("H1"),0)};
    document.getElementById("resetH2Btn").onclick=()=>{if(confirm("Reset tempo 2¬™ parte?"))resetTimer("H2");setTimeout(()=>fitCardsToViewport("H2"),0)};document.getElementById("resetP1Btn").onclick=()=>{if(confirm("Reset tempo 1¬™ Prol.?"))resetTimer("P1");setTimeout(()=>fitCardsToViewport("P1"),0)};document.getElementById("resetP2Btn").onclick=()=>{if(confirm("Reset tempo 2¬™ Prol.?"))resetTimer("P2");setTimeout(()=>fitCardsToViewport("P2"),0)};
    function fitCardsToViewport(half){
  const page = document.getElementById(half==="H1"?"pageH1":(half==="H2"?"pageH2":(half==="P1"?"pageP1":"pageP2")));
  if(!page || page.style.display==="none") return;
  const section = page.querySelector("section");
  const panel = document.getElementById(half==="H1"?"panel_H1":(half==="H2"?"panel_H2":(half==="P1"?"panel_P1":"panel_P2")));

  const header = document.querySelector("header");
  const headerH = header ? header.getBoundingClientRect().height : 0;
  const layoutPadding = 22;
  const vh = window.innerHeight || document.documentElement.clientHeight;
  const target = Math.max(240, vh - headerH - layoutPadding);

  let panelH = panel ? panel.getBoundingClientRect().height : target;
  const sync = Math.min(panelH, target);
  section.style.height = sync + "px";

  const titles = section.querySelectorAll(".rowTitle");
  let titlesH = 0; titles.forEach(t => titlesH += t.getBoundingClientRect().height);
  const usable = Math.max(150, sync - titlesH - 10);
  const rowH = Math.floor(usable / 3);

  const gridIds = (half==="H1")?["h1GridTop","h1GridMid","h1GridBot"]:(half==="H2")?["h2GridTop","h2GridMid","h2GridBot"]:(half==="P1")?["p1GridTop","p1GridMid","p1GridBot"]:["p2GridTop","p2GridMid","p2GridBot"];
  gridIds.forEach(id=>{
    const g = document.getElementById(id);
    if(!g) return;
    g.style.height = rowH + "px";
    g.style.alignItems = "stretch";
    g.style.gridAutoRows = "1fr";
    g.querySelectorAll(".card").forEach(cd=>{
      cd.style.height = "100%";
      cd.style.minHeight = "0px";
    });
  });
}
    function paintAll(){document.getElementById("matchLabel").textContent=state.matchName;paintProfiles();buildHalfLayout("H1");buildHalfLayout("H2");buildHalfLayout("P1");buildHalfLayout("P2");document.getElementById("defMin_H1").value=Math.round((state.halves.H1.duration||1200)/60);document.getElementById("defMin_H2").value=Math.round((state.halves.H2.duration||1200)/60);if(document.getElementById("defMin_P1"))document.getElementById("defMin_P1").value=Math.round((state.halves.P1?.duration||1200)/60);if(document.getElementById("defMin_P2"))document.getElementById("defMin_P2").value=Math.round((state.halves.P2?.duration||1200)/60);document.getElementById("venueSel").value=state.venue||"CASA";buildFivev4Box();buildTimeTable();updateScoreboards();["H1","H2","P1","P2"].forEach(updateTimerDisplay);setTimeout(()=>{["H1","H2","P1","P2"].forEach(fitCardsToViewport)},0)}
    window.addEventListener("resize",()=>{["H1","H2","P1","P2"].forEach(fitCardsToViewport)});window.addEventListener("orientationchange",()=>{setTimeout(()=>{["H1","H2","P1","P2"].forEach(fitCardsToViewport)},200)});
    load();
  </script>
</body>
</html>